name: run-strudel-on-branch

on:
  workflow_call:
    inputs:
      logger_name:
        default: 'strudel'
        required: false
        type: string
    secrets:
      strudel_access_key:
        required: true
      strudel_secret_key:
        required: true
  push:


jobs:
  pre_run_strudel_on_pull_request:
    runs-on: ubuntu-22.04
    outputs:
      run_strudel: ${{ steps.check_head_commit_message.outputs.run_strudel_value }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: check head commit message
        id: check_head_commit_message
        env:
          sha_last_commit: ${{ github.event.pull_request.head.sha }}
        shell: bash
        run: |
          last_commit=$(git log -1 --pretty=%B $sha_last_commit)
          echo "last_commit:  $last_commit"
          curl -sSL https://raw.githubusercontent.com/strudelbots/strudel-public/refs/heads/main/code/determine_strudel_action.sh -o /tmp/tmp.sh
          chmod +x /tmp/tmp.sh
          command=$(/tmp/tmp.sh  "$last_commit")
          echo "command is $command"
          echo "run_strudel_value=$command" >> "$GITHUB_OUTPUT"

  run-strudel:
    needs: pre_run_strudel_on_pull_request
    if: ${{ needs.pre_run_strudel_on_pull_request.outputs.run_strudel!='none' }}
    env:
      strudel_access_key: ${{ secrets.strudel_access_key }}
      strudel_secret_key: ${{ secrets.strudel_secret_key }}
    permissions:
      actions: write
      contents: write

    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract user branch name
        id: exract-branch-name
        uses: strudelbots/strudel-public/.github/actions/get_current_branch@main

      - name: extract strudel version
        id: extract_strudel_version
        uses: strudelbots/strudel-public/.github/actions/extract_strudel_version@8-change-run-logs-to-use-reusable-actions

      - name: Print strudel version
        shell: bash
        run: |
          echo "strudel version: ${{ env.ref }}"

      - name: get strudel-public files
        uses: strudelbots/strudel-public/.github/actions/get_public_files@main

      - name: check user keys
        uses: strudelbots/strudel-public/.github/actions/check-user-keys@main

      - name: install python
        id: install-python
        uses: strudelbots/strudel-public/.github/actions/install-python@main

      - name: login to ecr
        uses: strudelbots/strudel-public/.github/actions/login-to-ecr@main

      - name: run docker compose
        run: |
            export LOGGER_NAME=${{ inputs.logger_name }}
            export REPOSITORY_ROOT=${{ github.workspace }}
            export HASHER_STORAGE_TYPE=s3
            export STRUDEL_USER_ACCESS_KEY_ID=${{ secrets.strudel_access_key }}
            export STRUDEL_USER_SECRET_KEY="${{ secrets.strudel_secret_key }}"
            docker compose -f /tmp/docker_compose_run.yml up  -d --quiet-pull
            sleep 10
            docker ps -a
            docker logs logs

#      - name: Get changed files
#        id: get-changed-files
#        uses: tj-actions/changed-files@v45
#        with:
#          since_last_remote_commit: false
#      - name: List all changed files
#        env:
#          ALL_CHANGED_FILES: ${{ steps.get-changed-files.outputs.all_changed_files }}
#        run: |
#          echo "all changed files: $ALL_CHANGED_FILES"
#
#      - name: Run Strudel
#        run: |
#           export ALL_CHANGED_FILES="${{ steps.get-changed-files.outputs.all_changed_files }}"
#           export ROOT_DIR=$(pwd)/
#           export OVERWRITE_ORIG_FILES=True
#           echo run_strudel ${{ needs.pre_run_strudel_on_pull_request.outputs.run_strudel }}
#           python /tmp/strudel-public/github_run_strudel.py ${{ needs.pre_run_strudel_on_pull_request.outputs.run_strudel  }}
#      - name: Commit and push Strudel logs
#        run: |
#          if [ -z "$(git status --porcelain)" ]; then echo "no files to push" && exit 0; fi
#          git config --global user.name 'strudel-loger'
#          git config --global user.email 'strudel-logger@users.noreply.github.com'
#          git checkout ${{ steps.extract_branch.outputs.branch }}
#          git commit -am "Automated strudel-logger commit for branch ${{ steps.extract_branch.outputs.branch }}"
#          git push --set-upstream origin ${{ steps.extract_branch.outputs.branch }}
