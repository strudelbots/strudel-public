name: run-strudel-test

on:
  workflow_call:
    inputs:
      logger_name:
        default: 'strudel'
        required: false
        type: string
        description: 'The name of the logger to use'
    secrets:
      strudel_access_key:
        required: true
      strudel_secret_key:
        required: true
  workflow_dispatch:
jobs:
  run-strudel-test:
    runs-on: ubuntu-22.04
    env:
      strudel_access_key: ${{ secrets.strudel_access_key }}
      strudel_secret_key: ${{ secrets.strudel_secret_key }}
    steps:
      - uses: actions/checkout@v4
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract user branch name
        id: exract-branch-name
        uses: strudelbots/strudel-public/.github/actions/get_current_branch@5-map-action-to-specific-strudel-image

      - name: extract strudel version
        id: extract_strudel_version
        uses: strudelbots/strudel-public/.github/actions/extract_strudel_version@main


      - name: get strudel-public files
        uses: strudelbots/strudel-public/.github/actions/get_public_files@5-map-action-to-specific-strudel-image

      - name: check user keys
        uses: strudelbots/strudel-public/.github/actions/check-user-keys@5-map-action-to-specific-strudel-image

      - name: install python
        id: install-python
        uses: strudelbots/strudel-public/.github/actions/install-python@5-map-action-to-specific-strudel-image

      - name: login to ecr
        uses: strudelbots/strudel-public/.github/actions/login-to-ecr@5-map-action-to-specific-strudel-image

      - name: run docker compose
        run: |
            export LOGGER_NAME=${{ inputs.logger_name }}
            export REPOSITORY_ROOT=${{ github.workspace }}
            export HASHER_STORAGE_TYPE=s3
            export STRUDEL_USER_ACCESS_KEY_ID=${{ secrets.strudel_access_key }}
            export STRUDEL_USER_SECRET_KEY="${{ secrets.strudel_secret_key }}"
            docker compose -f /tmp/docker_compose_run.yml up  -d --quiet-pull
            sleep 10
            docker ps -a
            docker logs logs

      - name: sanity tests
        uses: strudelbots/strudel-public/.github/actions/sanity-tests@5-map-action-to-specific-strudel-image
